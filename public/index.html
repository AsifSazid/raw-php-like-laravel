<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the modal background overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body class="bg-gray-100 p-8">

    <div class="container mx-auto">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Product Index</h1>
            <button id="create-product-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                ➕ Create Product
            </button>
        </header>

        <hr class="mb-6">

        <div class="bg-white shadow-xl rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">All Products</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ser No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Action</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                ⏳ Loading products from API...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-center">
                <button id="load-more-products-btn"
                    class="hidden bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-6 rounded-lg shadow transition duration-300">
                    Load More 10 Products
                </button>
            </div>
        </div>

        <hr class="mb-8">

        <div id="orders-section" class="bg-white shadow-xl rounded-lg p-6" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Orders for Product: <span id="product-name-title"
                    class="text-blue-600"></span></h2>

            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-3">Create New Order</h3>
                <form id="create-order-form" class="space-y-4 md:space-y-0 md:flex md:gap-4 items-end">
                    <div class="flex-1">
                        <label for="order-customer" class="block text-sm font-medium text-blue-700">Customer
                            Name</label>
                        <input type="text" id="order-customer" required
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="w-24">
                        <label for="order-quantity" class="block text-sm font-medium text-blue-700">Quantity</label>
                        <input type="number" id="order-quantity" required min="1" value="1"
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div>
                        <button type="submit"
                            class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-300">
                            Place Order
                        </button>
                    </div>
                </form>
            </div>
            <h3 class="text-xl font-semibold mb-3 text-gray-700 mt-6">Order History</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Order ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Order Date</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-center">
                <button id="load-more-orders-btn"
                    class="hidden bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-6 rounded-lg shadow transition duration-300">
                    Load More 10 Orders
                </button>
            </div>
        </div>

    </div>

    <div id="create-product-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-overlay">
        <div
            class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 p-6 transform transition-all duration-300 scale-100 opacity-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Create New Product</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <form id="create-product-form">
                <div class="mb-4">
                    <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" id="product-name" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                    <input type="number" step="0.01" id="product-price" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="product-stock" class="block text-sm font-medium text-gray-700 mb-1">Initial
                        Stock</label>
                    <input type="number" id="product-stock" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex justify-end">
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                        Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- State Management ---
        let products = []; // Global array to store all products
        const productApiUrl = 'http://my_raw_php_task.test/api/products';
        const ordersApiBaseUrl = 'http://my_raw_php_task.test/api/orders/product/';

        let currentProductPage = 0;
        const productsPerPage = 10;

        let currentOrderOffset = 0;
        const ordersPerPage = 10;
        let activeProductId = null;

        // --- DOM Elements ---
        const productsTableBody = document.getElementById('products-table-body');
        const ordersTableBody = document.getElementById('orders-table-body');
        const ordersSection = document.getElementById('orders-section');
        const productNameTitle = document.getElementById('product-name-title');
        const loadMoreProductsBtn = document.getElementById('load-more-products-btn');
        const loadMoreOrdersBtn = document.getElementById('load-more-orders-btn');

        const createProductBtn = document.getElementById('create-product-btn');
        const createProductModal = document.getElementById('create-product-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const createProductForm = document.getElementById('create-product-form');
        const createOrderForm = document.getElementById('create-order-form');


        // --- DUMMY Order Data Store (Kept empty for successful API response tracking) ---
        const productOrders = {};


        // --- Functions (Product Management) ---

        /** Renders a chunk of products to the table. */
        function renderProducts(page) {
            const start = page * productsPerPage;
            const end = start + productsPerPage;
            const productsToShow = products.slice(start, end);

            // Clear the loading message if this is the first page
            if (page === 0) {
                productsTableBody.innerHTML = '';
            }

            let html = '';
            productsToShow.forEach((product, index) => {
                const serialNumber = start + index + 1;
                const priceValue = parseFloat(product.price);

                html += `
                    <tr class="hover:bg-gray-50 cursor-pointer product-row" data-product-id="${product.id}" data-product-name="${product.name}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${serialNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${priceValue.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 view-orders-btn" data-product-id="${product.id}" data-product-name="${product.name}">View Orders</button>
                        </td>
                    </tr>
                `;
            });

            productsTableBody.innerHTML += html;

            currentProductPage = page + 1;

            if (products.length <= currentProductPage * productsPerPage) {
                loadMoreProductsBtn.classList.add('hidden');
            } else {
                loadMoreProductsBtn.classList.remove('hidden');
            }
        }


        /** * FIX: Handles the creation of a new product, ensuring the correct ID is used from the API 
         * without causing a network error if the API doesn't return a perfect ID format.
         */
        async function handleCreateProduct(event) {
            event.preventDefault();

            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value, 10);

            if (name === '' || isNaN(price) || isNaN(stock) || price <= 0 || stock < 0) {
                alert('Please fill out all fields correctly with valid numbers for Price ( > 0) and Stock (>= 0).');
                return;
            }

            const productData = {
                name: name,
                price: price.toFixed(2),
                stock: stock.toString()
            };

            try {
                const response = await fetch(productApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });

                console.log(response.json)
                if (response.ok) {
                    // Close modal and reset form immediately
                    createProductModal.classList.add('hidden');
                    createProductModal.classList.remove('flex');
                    createProductForm.reset();

                    // --- CORE CHANGE: Full Data Re-Initialization ---

                    // 1. Clear the local product array
                    products = [];
                    // 2. Clear the table display (optional, initializeProducts handles this)
                    productsTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">🔄 Reloading product data...</td></tr>';
                    currentProductPage = 0;

                    // 3. Re-fetch ALL products (including the new one) and re-render the table
                    await initializeProducts();

                    // alert(`✅ Product saved successfully! The product list has been refreshed.`);

                } else {
                    const errorText = await response.text();
                    alert(`❌ Failed to save product. Server responded with status ${response.status}. Error: ${errorText}`);
                }

            } catch (error) {
                console.error('Network or CORS error:', error);
                // Renamed error message to match your initial message for consistency
                alert('A network error occurred. Could not connect to the product API.');
            }
        }


        // --- Functions (Order Management - DYNAMIC) ---

        /** Fetches and renders a chunk of orders for the active product from the API. */
        async function fetchAndRenderOrders(productId, offset) {
            const ordersApiUrl = `${ordersApiBaseUrl}${productId}?limit=${ordersPerPage}&offset=${offset}`;

            try {
                const response = await fetch(ordersApiUrl);

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorData.substring(0, 100)}...`);
                }

                const data = await response.json();

                const ordersArray = data.data || [];
                const totalCount = data.total_count || 0;

                if (offset === 0) {
                    ordersTableBody.innerHTML = '';
                }

                if (ordersArray.length === 0 && offset === 0) {
                    ordersTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">
                        No orders found for this product.
                    </td></tr>`;
                    loadMoreOrdersBtn.classList.add('hidden');
                    return;
                }

                renderOrdersToTable(ordersArray, totalCount);

                currentOrderOffset += ordersArray.length;

            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-600">
                    No orders found for this product
                </td></tr>`;
            }
        }

        /** Renders a list of orders (from API data) to the table body. */
        function renderOrdersToTable(ordersToShow, totalOrderCount) {
            let html = '';
            ordersToShow.forEach(order => {
                // Use API response keys
                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.order_id || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customer_name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.qty || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.created_at || 'N/A'}</td>
                    </tr>
                `;
            });

            ordersTableBody.innerHTML += html;

            // Logic for Load More button visibility
            if (totalOrderCount > currentOrderOffset + ordersToShow.length) {
                loadMoreOrdersBtn.classList.remove('hidden');
            } else {
                loadMoreOrdersBtn.classList.add('hidden');
            }
        }

        /** Clears the current order list and initiates the fetch for the first page of orders. */
        async function showProductOrders(productId, productName) {
            activeProductId = productId;
            currentOrderOffset = 0; // Reset offset for a new product

            productNameTitle.textContent = productName;
            ordersSection.style.display = 'block';

            // Show loading message immediately
            ordersTableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">⏳ Loading orders...</td></tr>';
            loadMoreOrdersBtn.classList.add('hidden');

            // Scroll to the orders section
            ordersSection.scrollIntoView({ behavior: 'smooth' });

            // Fetch and render the first batch of orders
            await fetchAndRenderOrders(productId, currentOrderOffset);
        }

        /** Handles the creation of a new order for the active product using the API. */
        async function handleCreateOrder(event) {
            event.preventDefault();

            if (!activeProductId) {
                alert("Error: No product selected for this order.");
                return;
            }

            const customer = document.getElementById('order-customer').value.trim();
            const quantity = parseInt(document.getElementById('order-quantity').value, 10);

            const product = products.find(p => p.id === activeProductId);

            if (customer === '' || isNaN(quantity) || quantity <= 0) {
                alert('Please enter a valid customer name and a quantity greater than zero.');
                return;
            }

            if (product && product.stock < quantity) {
                alert(`Insufficient stock. Only ${product.stock} left.`);
                return;
            }

            const totalPrice = product ? (product.price * quantity).toFixed(2) : 0;

            const orderData = {
                product_id: activeProductId,
                customer_name: customer,
                qty: quantity, // API expects 'qty'
                total_price: parseFloat(totalPrice)
            };

            const API_ENDPOINT = 'http://my_raw_php_task.test/api/orders';

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const result = await response.json();

                    if (product) {
                        product.stock -= quantity; // Update local stock
                    }

                    productsTableBody.innerHTML = '';
                    currentProductPage = 0;
                    renderProducts(currentProductPage);

                    await showProductOrders(activeProductId, productNameTitle.textContent);

                    createOrderForm.reset();
                    alert(`✅ Order placed successfully! ID: ${result.order_id || 'N/A'}`);

                } else {
                    const errorText = await response.text();
                    alert(`❌ Failed to place order. Server responded with status ${response.status}. Error: ${errorText}`);
                }

            } catch (error) {
                console.error('Network or CORS error:', error);
                alert('A network error occurred. Could not connect to the Orders API.');
            }
        }


        // --- Data Fetching and Initialization ---

        async function initializeProducts() {
            try {
                const response = await fetch(productApiUrl);

                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                const data = await response.json();

                let productsData = data.data;

                productsData.forEach(product => {
                    products.push({
                        id: parseInt(product.id),
                        name: product.name,
                        price: parseFloat(product.price),
                        stock: parseInt(product.stock)
                    });
                });

                // Add Dummy Data (Ensuring Dummy IDs are much higher than real IDs)
                const maxApiId = products.length > 0 ? Math.max(...products.map(p => p.id)) : 0;
                const startId = maxApiId + 1000; // Start dummy IDs much higher

                for (let i = startId; i < startId + 30; i++) {
                    products.push({
                        id: i,
                        name: `Dummy Product X-${i}`,
                        price: parseFloat((10 + i * 0.05).toFixed(2)),
                        stock: 100 + (i % 50)
                    });
                }

                // Initial Load: Start rendering the first page of products
                renderProducts(currentProductPage);

            } catch (error) {
                console.error("There was a problem with the fetch operation:", error);
                productsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-600">
                    ❌ Failed to load products. Check your API URL or CORS policy.
                </td></tr>`;
            }
        }

        // --- Event Listeners ---

        // 1. Modal Toggle (Product)
        createProductBtn.addEventListener('click', () => {
            createProductModal.classList.remove('hidden');
            createProductModal.classList.add('flex');
        });

        closeModalBtn.addEventListener('click', () => {
            createProductModal.classList.add('hidden');
            createProductModal.classList.remove('flex');
        });

        createProductModal.addEventListener('click', (e) => {
            if (e.target === createProductModal) {
                createProductModal.classList.add('hidden');
                createProductModal.classList.remove('flex');
            }
        });

        // 2. Form Submission (Save Product)
        createProductForm.addEventListener('submit', handleCreateProduct);

        // 3. Form Submission (Save Order)
        createOrderForm.addEventListener('submit', handleCreateOrder);


        // 4. View Orders (Click on a product row or button)
        productsTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('.product-row, .view-orders-btn');
            if (row) {
                const targetRow = e.target.closest('tr');
                const productId = parseInt(targetRow.dataset.productId);
                const productName = targetRow.dataset.productName;

                showProductOrders(productId, productName);
            }
        });

        // 5. Load More Products
        loadMoreProductsBtn.addEventListener('click', () => {
            renderProducts(currentProductPage);
        });

        // 6. Load More Orders (NOW DYNAMICALLY FETCHES FROM API)
        loadMoreOrdersBtn.addEventListener('click', () => {
            if (activeProductId) {
                fetchAndRenderOrders(activeProductId, currentOrderOffset);
            }
        });


        // --- Application Start ---
        initializeProducts();
    </script>
</body>

</html>