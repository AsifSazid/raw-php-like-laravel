<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the modal background overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body class="bg-gray-100 p-8">

    <div class="container mx-auto">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Product Index</h1>
            <button id="create-product-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                ➕ Create Product
            </button>
        </header>

        <hr class="mb-6">

        <div class="bg-white shadow-xl rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">All Products</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ser No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Action</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                ⏳ Loading products from API...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-center">
                <button id="load-more-products-btn"
                    class="hidden bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-6 rounded-lg shadow transition duration-300">
                    Load More 10 Products
                </button>
            </div>
        </div>

        <hr class="mb-8">

        <div id="orders-section" class="bg-white shadow-xl rounded-lg p-6" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Orders for Product: <span id="product-name-title"
                    class="text-blue-600"></span></h2>

            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-3">Create New Order</h3>
                <form id="create-order-form" class="space-y-4 md:space-y-0 md:flex md:gap-4 items-end">
                    <div class="flex-1">
                        <label for="order-customer" class="block text-sm font-medium text-blue-700">Customer
                            Name</label>
                        <input type="text" id="order-customer" required
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="w-24">
                        <label for="order-quantity" class="block text-sm font-medium text-blue-700">Quantity</label>
                        <input type="number" id="order-quantity" required min="1" value="1"
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div>
                        <button type="submit"
                            class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-300">
                            Place Order
                        </button>
                    </div>
                </form>
            </div>
            <h3 class="text-xl font-semibold mb-3 text-gray-700 mt-6">Order History</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Order ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Order Date</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-center">
                <button id="load-more-orders-btn"
                    class="hidden bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-6 rounded-lg shadow transition duration-300">
                    Load More 10 Orders
                </button>
            </div>
        </div>

    </div>

    <div id="create-product-modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-overlay">
        <div
            class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 p-6 transform transition-all duration-300 scale-100 opacity-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Create New Product</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <form id="create-product-form">
                <div class="mb-4">
                    <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" id="product-name" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                    <input type="number" step="0.01" id="product-price" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="product-stock" class="block text-sm font-medium text-gray-700 mb-1">Initial
                        Stock</label>
                    <input type="number" id="product-stock" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex justify-end">
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                        Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- State Management ---
        let products = []; // Global array to store all products (API + Dummy)
        const productApiUrl = 'http://my_raw_php_task.test/api/products';

        let currentProductPage = 0;
        const productsPerPage = 10;
        let currentOrderPage = 0;
        const ordersPerPage = 10;
        let activeProductId = null; // Stores the ID of the currently selected product

        // --- DOM Elements ---
        const productsTableBody = document.getElementById('products-table-body');
        const ordersTableBody = document.getElementById('orders-table-body');
        const ordersSection = document.getElementById('orders-section');
        const productNameTitle = document.getElementById('product-name-title');
        const loadMoreProductsBtn = document.getElementById('load-more-products-btn');
        const loadMoreOrdersBtn = document.getElementById('load-more-orders-btn');

        const createProductBtn = document.getElementById('create-product-btn');
        const createProductModal = document.getElementById('create-product-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const createProductForm = document.getElementById('create-product-form');
        const createOrderForm = document.getElementById('create-order-form');


        // --- Dummy Order Data Store (Replace with API fetch in a real app) ---
        const productOrders = {
            1: [
                { orderId: 'ORD001', customer: 'Alice', quantity: 2, date: '2024-10-15' },
                { orderId: 'ORD002', customer: 'Bob', quantity: 1, date: '2024-10-16' },
            ],
            2: [
                { orderId: 'ORD101', customer: 'Charlie', quantity: 5, date: '2024-10-14' },
                { orderId: 'ORD102', customer: 'Dave', quantity: 3, date: '2024-10-15' },
            ],
        };

        // Populate product 1 with many more orders for pagination
        for (let i = 3; i <= 30; i++) {
            if (!productOrders[1]) productOrders[1] = [];
            productOrders[1].push({
                orderId: `ORD00${i}`,
                customer: `Customer ${i}`,
                quantity: Math.floor(Math.random() * 5) + 1,
                date: `2024-10-${i < 10 ? '0' + i : i}`
            });
        }


        // --- Functions (Product Management) ---

        /** Renders a chunk of products to the table. */
        function renderProducts(page) {
            const start = page * productsPerPage;
            const end = start + productsPerPage;
            const productsToShow = products.slice(start, end);

            // Clear the loading message if this is the first page
            if (page === 0) {
                productsTableBody.innerHTML = '';
            }

            let html = '';
            productsToShow.forEach((product, index) => {
                // Ensure price is treated as a number before calling toFixed
                const serialNumber = start + index + 1;
                const priceValue = parseFloat(product.price);

                html += `
                    <tr class="hover:bg-gray-50 cursor-pointer product-row" data-product-id="${product.id}" data-product-name="${product.name}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${serialNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${priceValue.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 view-orders-btn" data-product-id="${product.id}" data-product-name="${product.name}">View Orders</button>
                        </td>
                    </tr>
                `;
            });

            productsTableBody.innerHTML += html;

            currentProductPage = page + 1;

            if (products.length <= currentProductPage * productsPerPage) {
                loadMoreProductsBtn.classList.add('hidden');
            } else {
                loadMoreProductsBtn.classList.remove('hidden');
            }
        }


        /** Handles the creation of a new product by sending data to the API. */
        async function handleCreateProduct(event) {
            event.preventDefault();

            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value, 10);

            if (name === '' || isNaN(price) || isNaN(stock) || price <= 0 || stock < 0) {
                alert('Please fill out all fields correctly with valid numbers for Price ( > 0) and Stock (>= 0).');
                return;
            }

            const productData = {
                name: name,
                // Send price and stock as strings to prevent precision issues during transfer
                price: price.toFixed(2),
                stock: stock.toString()
            };

            try {
                // Send the POST request to the API
                const response = await fetch(productApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });

                // Handle the API response
                if (response.ok) {
                    const result = await response.json();

                    // --- SUCCESS: Update Frontend ---
                    const newProduct = {
                        // Use ID from API result if available, otherwise use a local fallback
                        id: result.id || (products.length > 0 ? products[0].id + 1 : 1),
                        name: name,
                        price: price, // Store as numeric for rendering/logic
                        stock: stock
                    };

                    // Add to the beginning of the list and initialize orders array
                    products.unshift(newProduct);
                    productOrders[newProduct.id] = [];

                    // Clear and re-render the first page of products
                    productsTableBody.innerHTML = '';
                    currentProductPage = 0;
                    renderProducts(currentProductPage);

                    // Close modal and reset form
                    createProductModal.classList.add('hidden');
                    createProductModal.classList.remove('flex');
                    createProductForm.reset();

                    alert(`Product "${name}" saved successfully! New ID: ${newProduct.id}`);

                } else {
                    const errorText = await response.text();
                    alert(`Failed to save product. Server responded with status ${response.status}. Error: ${errorText}`);
                }

            } catch (error) {
                console.error('Network or CORS error:', error);
                alert('A network error occurred. Could not connect to the product API.');
            }
        }

        // --- Functions (Order Management) ---

        /** Renders a chunk of orders for the active product. */
        function renderOrders(productId, page) {
            const orders = productOrders[productId] || [];
            const start = page * ordersPerPage;
            const end = start + ordersPerPage;
            const ordersToShow = orders.slice(start, end);

            if (page === 0) {
                ordersTableBody.innerHTML = '';
            }

            let html = '';
            ordersToShow.forEach(order => {
                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.orderId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customer}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.date}</td>
                    </tr>
                `;
            });

            ordersTableBody.innerHTML += html;

            currentOrderPage = page + 1;

            if (orders.length <= currentOrderPage * ordersPerPage) {
                loadMoreOrdersBtn.classList.add('hidden');
            } else {
                loadMoreOrdersBtn.classList.remove('hidden');
            }
        }

        /** Clears the current order list and renders the first page of orders for a product. */
        function showProductOrders(productId, productName) {
            activeProductId = productId;
            currentOrderPage = 0;
            ordersTableBody.innerHTML = '';

            productNameTitle.textContent = productName;
            ordersSection.style.display = 'block';

            renderOrders(productId, currentOrderPage);

            // Scroll to the orders section
            ordersSection.scrollIntoView({ behavior: 'smooth' });
        }

        /** Handles the creation of a new order for the active product using the API. */
        async function handleCreateOrder(event) {
            event.preventDefault();

            if (!activeProductId) {
                alert("Error: No product selected for this order.");
                return;
            }

            const customer = document.getElementById('order-customer').value.trim();
            const quantity = parseInt(document.getElementById('order-quantity').value, 10);

            // Find the product locally to check stock and get price for total_price calculation
            const product = products.find(p => p.id === activeProductId);

            if (customer === '' || isNaN(quantity) || quantity <= 0) {
                alert('Please enter a valid customer name and a quantity greater than zero.');
                return;
            }

            // Pre-flight stock check (Server must also validate this!)
            if (product && product.stock < quantity) {
                alert(`Insufficient stock. Only ${product.stock} left.`);
                return;
            }

            // Calculate total price for the API
            const totalPrice = product ? (product.price * quantity).toFixed(2) : 0;

            // 1. Prepare data in the EXACT format the API expects
            const orderData = {
                product_id: activeProductId,
                customer_name: customer,
                // *** CRITICAL FIX: Changed 'quantity' to 'qty' ***
                qty: quantity,
                total_price: parseFloat(totalPrice) // Send as float/number
                // 'order_id' is usually created by the server, so we omit it here.
            };

            const API_ENDPOINT = 'http://my_raw_php_task.test/api/orders';

            try {
                // 2. Send the POST request to the Orders API
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });

                // 3. Handle the API response
                if (response.ok) {
                    // Assuming the API returns the created order data (e.g., ID, date, final price)
                    const result = await response.json();

                    // --- SUCCESS: Update Frontend State ---

                    // a) Update local product stock 
                    if (product) {
                        product.stock -= quantity;
                    }

                    // b) Add new order to the local productOrders dummy store
                    const newOrder = {
                        orderId: result.order_id || 'ORD-NEW-' + activeProductId, // Use API's returned order_id
                        customer: customer,
                        quantity: quantity,
                        date: result.date || new Date().toISOString().slice(0, 10)
                    };

                    if (!productOrders[activeProductId]) productOrders[activeProductId] = [];
                    productOrders[activeProductId].unshift(newOrder);

                    // c) Reset and re-render the products table to show updated stock
                    productsTableBody.innerHTML = '';
                    currentProductPage = 0;
                    renderProducts(currentProductPage);

                    // d) Reset and re-render the orders table to show the new order
                    showProductOrders(activeProductId, productNameTitle.textContent);

                    createOrderForm.reset();
                    alert(`✅ Order placed successfully! ID: ${newOrder.orderId}`);

                } else {
                    // Handle HTTP error statuses
                    const errorText = await response.text();
                    alert(`❌ Failed to place order. Server responded with status ${response.status}. Error: ${errorText}`);
                }

            } catch (error) {
                // Handle network errors
                console.error('Network or CORS error:', error);
                alert('A network error occurred. Could not connect to the Orders API.');
            }
        }
        
        // --- Data Fetching and Initialization ---

        async function initializeProducts() {
            try {
                const response = await fetch(productApiUrl);

                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                const data = await response.json();

                // 1. Process API Data
                let productsData = data.data;

                // Populate the global 'products' array with API data
                productsData.forEach(product => {
                    products.push({
                        id: parseInt(product.id), // Ensure ID is integer
                        name: product.name,
                        price: parseFloat(product.price), // Ensure price is float for calculation/rendering
                        stock: parseInt(product.stock) // Ensure stock is integer
                    });
                });

                // 2. Add Dummy Data (ONLY after API data is loaded)
                // We start IDs from 1000 to avoid conflicts with API data IDs
                const startId = 1000;
                for (let i = startId; i < startId + 30; i++) {
                    products.push({
                        id: i,
                        name: `Dummy Product X-${i}`,
                        price: parseFloat((10 + i * 0.05).toFixed(2)),
                        stock: 100 + (i % 50)
                    });
                }

                // 3. Initial Load: Start rendering the first page of products
                renderProducts(currentProductPage);

            } catch (error) {
                console.error("There was a problem with the fetch operation:", error);
                productsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-600">
                    ❌ Failed to load products. Check your API URL or CORS policy.
                </td></tr>`;
            }
        }

        // --- Event Listeners ---

        // 1. Modal Toggle (Product)
        createProductBtn.addEventListener('click', () => {
            createProductModal.classList.remove('hidden');
            createProductModal.classList.add('flex');
        });

        closeModalBtn.addEventListener('click', () => {
            createProductModal.classList.add('hidden');
            createProductModal.classList.remove('flex');
        });

        createProductModal.addEventListener('click', (e) => {
            if (e.target === createProductModal) {
                createProductModal.classList.add('hidden');
                createProductModal.classList.remove('flex');
            }
        });

        // 2. Form Submission (Save Product)
        createProductForm.addEventListener('submit', handleCreateProduct);

        // 3. Form Submission (Save Order)
        createOrderForm.addEventListener('submit', handleCreateOrder);


        // 4. View Orders (Click on a product row or button)
        productsTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('.product-row, .view-orders-btn');
            if (row) {
                const targetRow = e.target.closest('tr');
                const productId = parseInt(targetRow.dataset.productId);
                const productName = targetRow.dataset.productName;

                showProductOrders(productId, productName);
            }
        });

        // 5. Load More Products
        loadMoreProductsBtn.addEventListener('click', () => {
            renderProducts(currentProductPage);
        });

        // 6. Load More Orders
        loadMoreOrdersBtn.addEventListener('click', () => {
            if (activeProductId) {
                renderOrders(activeProductId, currentOrderPage);
            }
        });


        // --- Application Start ---
        initializeProducts();
    </script>
</body>

</html>